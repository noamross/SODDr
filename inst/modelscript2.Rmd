```{r loadparms}
library(SODDr)
data(twospecies)
treeparms.df <- twospecies
print(treeparms.df)
```

```{r makelocations}
locations <- MakeLattice(nx=20,ny=20,dist=1)
head(locations)
```

```{r initial.values}
initial.vec = as.vector(rbind(treeparms.df$S.init, treeparms.df$I.init))
init <- matrix(data=initial.vec, nrow=nrow(locations), 
               ncol=2*nrow(treeparms.df), byrow=TRUE)
time.steps <- 1:100
```

```{r}
pop.df <- SODModel(treeparms.df,locations,time.steps,init)
str(pop.df)
```


#Results
Here are the results, broken up by species and age class:

```{r initrun,fig.cap="Population dynamics broken up by species and size Class"}
library(ggplot2)
library(plyr)
pop.df.totals <- ddply(pop.df, c("Time", "Disease", "Species", "SizeClass"),
                       summarise, AvePop=mean(Population))
dynamic.plot <- ggplot(subset(pop.df.totals, Time <=1000),
                       aes(x=Time,y=AvePop, fill=Disease, alpha=SizeClass)) + 
                  geom_area(position="stack") + facet_grid(~Species) + 
                  scale_alpha_manual(values=c(0.5,0.8))
dynamic.plot
```

Now with disease:

```{r disease1, fig.cap="Tanoak as a fraction of total population, using baseline initial conditions and introducing disease"}
init[190,2] <- init[190,1]
init[190,1] <- 0
init[190,4] <- init[190,3]
init[190,3] <- 0
pop2.df <- SODModel(treeparms.df,locations,time.steps,init)
pop2.df.totals <- ddply(pop2.df, c("Time", "Disease", "Species", "SizeClass"),
                       summarise, AvePop=mean(Population))
dynamic.plot <- ggplot(pop2.df.totals,
                       aes(x=Time,y=AvePop, fill=Disease, alpha=SizeClass)) + 
                  geom_area(position="stack") + facet_grid(~Species) +
                  scale_alpha_manual(values=c(0.5,0.8))
dynamic.plot

```

The plot shows This isn't quite steady-state, I suspect because of some rounding errors in copying parameters from the paper.

We can make a plot in the style of @Cobb2012, showing only the populations of small and large tanoaks as a proportion of the total population:

```{r papeplot, fig.cap="Tanoak as a fraction of total population over time, no disease"}
0paper.df <- ddply(transform(pop.df.totals, Size = ifelse(SizeClass == "1" | SizeClass == "2", "Small", "Large")), c("Time", "Species", "Size"), summarise, SizePop=sum(TotPop))
paper.df <- ddply(paper.df, "Time", transform, Pct=SizePop/sum(SizePop))
paper.plot <- ggplot(subset(paper.df, Species=="Tanoak"), aes(x=Time, y=Pct, lty=Size)) + geom_line(lwd=1) + scale_y_continuous(limits=c(0,0.6), expand=c(0,0)) + scale_x_continuous(expand=c(0,0)) + scale_linetype_manual(values=c(1,5)) + theme_bw() + theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank())
paper.plot
```

Now, let's change the initial conditions to include disease and see what happens.  I change the populations of tanoak and bay in one pixel to infectious instead of healthy and run the model:


pop2.df.totals <- ddply(pop2.df, c("Time", "Disease", "Species", "SizeClass"),
                       summarise, AvePop=mean(Population))
paper2.df <- ddply(transform(pop2.df.totals, Size = ifelse(SizeClass == "1" | SizeClass == "2", "Small", "Large")), c("Time", "Species", "Size"), summarise, SizePop=sum(AvePop))
paper2.df <- ddply(paper2.df, "Time", transform, Pct=SizePop/sum(SizePop))
paper2.plot <- ggplot(subset(paper2.df, Species=="Tanoak"), aes(x=Time, y=Pct, lty=Size)) + geom_line(lwd=1) + scale_y_continuous(limits=c(0,0.6), expand=c(0,0)) + scale_x_continuous(expand=c(0,0)) + scale_linetype_manual(values=c(1,5)) + theme_bw() + theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank())
paper2.plot
```

Qualitatively, this looks a lot like the original result:

![Figure 4a from @Cobb2012](http://dl.dropbox.com/u/3356641/blogstuff/cobb20124a.png)

The main difference is the overall rate of change, which is expected because I haven't corrected any parameters for the change from continuous to discrete time.

Now I simulate a scenario with mostly tanoak, some redwood, and no bay laurel, with disease, using the parameters previously calulated for the steady state without disease:

```{r disease2, fig.cap='Tanoak dynamics under the "Mostly Tanoak" scenario'}
treeparms.df$S.init <- c(0.7*treeparms.df$S.init[1:4]/sum(treeparms.df$S.init[1:4]),0,0.19)

initial.vec = as.vector(rbind(treeparms.df$S.init, treeparms.df$I.init))
init <- matrix(data=initial.vec, nrow=nrow(locations), 
               ncol=2*nrow(treeparms.df), byrow=TRUE)

init[190,2] <- init[190,1]
init[190,1] <- 0
init[190,10] <- init[190,9]
init[190,9] <- 0

treeparms.df <- within(treeparms.df, {
# Calculate the relative space requirements of tanoak size classes
# based on initial conditions
space[1:4] <- 0.25*(sum(S.init[1:4])/S.init[1:4])

# Set recruitment rates to steady-state levels.  For Redwood and Bay, this is 
# simply the mortality rate divided by the density-dependence coefficient at 
# simulation start.  For tanoak, which has multiple size classes, it's a but
# more involved

S.recruit[5] <- S.mortality[5]/(1-sum(S.init * space))
I.recruit[5] <- I.mortality[5]/(1-sum(S.init * space))
S.recruit[6] <- S.mortality[6]/(1-sum(S.init * space))
I.recruit[6] <- I.mortality[6]/(1-sum(S.init * space))

A2 <- S.transition[1]/(S.transition[2] + S.mortality[2])
A3 <- (S.transition[2]/(S.transition[3] + S.mortality[3])) * A2
A4 <- (S.transition[3]/S.mortality[4]) * A3
S.recruit[1] <- (S.transition[1] + S.mortality[1])/(1-sum(S.init * space)) -
                (S.recruit[2] * A2 + S.recruit[3] * A3 + S.recruit[4] * A4)


I.recruit[1] <- S.recruit[1] 
A2 <- NULL
A3 <- NULL
A4 <- NULL
})

pop3.df <- SODModel(treeparms.df,locations,time.steps,init)
pop3.df.totals <- ddply(pop3.df, c("Time", "Disease", "Species", "SizeClass"),
                       summarise, TotPop=mean(Population))
paper3.df <- ddply(transform(pop3.df.totals, Size = ifelse(SizeClass == "1" | SizeClass == "2", "Small", "Large")), c("Time", "Species", "Size"), summarise, SizePop=sum(TotPop))
paper3.df <- ddply(paper3.df, "Time", transform, Pct=SizePop/sum(SizePop))
paper3.plot <- ggplot(subset(paper3.df, Species=="Tanoak"), aes(x=Time, y=Pct, lty=Size)) + geom_line(lwd=1) + scale_y_continuous(limits=c(0,0.6), expand=c(0,0)) + scale_x_continuous(expand=c(0,0)) + scale_linetype_manual(values=c(1,5)) + theme_bw() + theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank())
paper3.plot
```

Again, qualitatively similar to the original results:

![Fig 4b from @Cobb2012](http://dl.dropbox.com/u/3356641/blogstuff/cobb2012fig4b.png)

Finally, I simulation the "Mostly Redwwod" scenario:

```{r disease3, fig.cap='Tanoak dynamics under the "mostly redwood" scenario'}
treeparms.df$S.init <- c(0.08*treeparms.df$S.init[1:4]/sum(treeparms.df$S.init[1:4]),0,0.69)

initial.vec = as.vector(rbind(treeparms.df$S.init, treeparms.df$I.init))
init <- matrix(data=initial.vec, nrow=nrow(locations), 
               ncol=2*nrow(treeparms.df), byrow=TRUE)

init[190,2] <- init[190,1]
init[190,1] <- 0
init[190,10] <- init[190,9]
init[190,9] <- 0

treeparms.df <- within(treeparms.df, {
# Calculate the relative space requirements of tanoak size classes
# based on initial conditions
space[1:4] <- 0.25*(sum(S.init[1:4])/S.init[1:4])

# Set recruitment rates to steady-state levels.  For Redwood and Bay, this is 
# simply the mortality rate divided by the density-dependence coefficient at 
# simulation start.  For tanoak, which has multiple size classes, it's a but
# more involved

S.recruit[5] <- S.mortality[5]/(1-sum(S.init * space))
I.recruit[5] <- I.mortality[5]/(1-sum(S.init * space))
S.recruit[6] <- S.mortality[6]/(1-sum(S.init * space))
I.recruit[6] <- I.mortality[6]/(1-sum(S.init * space))

A2 <- S.transition[1]/(S.transition[2] + S.mortality[2])
A3 <- (S.transition[2]/(S.transition[3] + S.mortality[3])) * A2
A4 <- (S.transition[3]/S.mortality[4]) * A3
S.recruit[1] <- (S.transition[1] + S.mortality[1])/(1-sum(S.init * space)) -
                (S.recruit[2] * A2 + S.recruit[3] * A3 + S.recruit[4] * A4)


I.recruit[1] <- S.recruit[1] 
A2 <- NULL
A3 <- NULL
A4 <- NULL
})

pop4.df <- SODModel(treeparms.df,locations,time.steps,init)
pop4.df.totals <- ddply(pop4.df, c("Time", "Disease", "Species", "SizeClass"),
                       summarise, TotPop=mean(Population))
paper4.df <- ddply(transform(pop4.df.totals, Size = ifelse(SizeClass == "1" | SizeClass == "2", "Small", "Large")), c("Time", "Species", "Size"), summarise, SizePop=sum(TotPop))
paper4.df <- ddply(paper4.df, "Time", transform, Pct=SizePop/sum(SizePop))
paper4.plot <- ggplot(subset(paper4.df, Species=="Tanoak"), aes(x=Time, y=Pct, lty=Size)) + geom_line(lwd=1) + scale_y_continuous(limits=c(0,0.6), expand=c(0,0)) + scale_x_continuous(expand=c(0,0)) + scale_linetype_manual(values=c(1,5)) + theme_bw() + theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank())
paper4.plot
```

Success!  Same results as the original:

![Figure 4c from @Cobb2012](http://dl.dropbox.com/u/3356641/blogstuff/cobb2012fig4c.png)

Now, for fun, let's make an animation of how the disease progresses through the stand.  I will use the "Mostly Tanoak" scenario", and plot the adult population as intensity, and the fraction of trees diseased as hue.

```{r tanoak-anim, fig.show='animate', interval=0.2}
tanspc <- subset(pop3.df, Species=="Tanoak")
tanspc$Species <- NULL
tanspc <- ddply(tanspc, c("Time","Location"), function(x) {data.frame(TotTan=sum(x$Population[which(x$SizeClass=="3" | x$SizeClass=="4")]), FracDisease=sum(x$Population[which(x$Disease=="I" & (x$SizeClass=="3" | x$SizeClass=="4"))])/sum(x$Population[which(x$SizeClass=="3" | x$SizeClass=="4")]))})
tanspc <- merge(tanspc, as.data.frame(locations), by.x="Location", by.y="location")
dis.limits <- c(min(tanspc$FracDisease),max(tanspc$FracDisease))
pop.limits <- c(min(tanspc$TotTan),max(tanspc$TotTan))
require(animation)
ani.options(nmax=50,loop=TRUE, interval=0.2)
for (time in time.steps) {
    print(ggplot(data=subset(tanspc, Time==time), 
           aes(x=x,y=y,fill=FracDisease, alpha=TotTan)) +
    geom_tile() +
    scale_alpha(name="TanoakPopulation", limits=c(0,0.4), breaks=seq(0,0.4,0.1)) +
    scale_fill_continuous(name="Fraction Diseased",limits=c(0,1), breaks=seq(0,1,0.25), low="#408000", high="#FF8000") +
    theme(rect=element_blank(), line=element_blank()))
  }
```